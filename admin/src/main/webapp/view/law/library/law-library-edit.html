<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../../lib/layui/css/layui.css" type="text/css"/>
    <link rel="stylesheet" href="../../../css/xadmin.css">
    <script type="text/javascript" src="../../../lib/layui/layui.all.js"></script>
    <script type="text/javascript" src="../../../js/xadmin.js"></script>
    <script type="text/javascript" src="../../../js/baseUtils.js"></script>
    <script type="text/javascript" src="../../../js/LawUtils.js"></script>
    <title>法务编辑</title>
    <!--[if lt IE 9]>
   <script type="text/javascript" src="../../../js/html5shiv.min.js"></script>
   <script type="text/javascript" src="../../../js/respond.js"></script>
    <![endif]-->
   <meta name="renderer" content="webkit">
   <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>
<body>
<div class="layui-fluid">
   <div class="layui-row">
       <form class="layui-form" id="form" lay-filter="form">
           <div class="layui-form-item">
               <label class="layui-form-label">法务类型</label>
               <div class="layui-input-inline">
                   <select id="law_type_id">
                       <option value="">请选择一个法务类型</option>
                   </select>
               </div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">法务标题</label>
               <div class="layui-input-inline">
                   <input type="text" id="title" name="title" placeholder="请输入标题" lay-verify="required"
                          lay-verType="tips" autocomplete="off" class="layui-input" style="width: 600px"></div>
           </div>
           <div class="layui-form-item">
               <label class="layui-form-label">法务知识内容</label>
               <div class="layui-input-inline" style="width: 600px">
                   <textarea id="content" name="content" lay-verify="content" style="display: none;"></textarea>
               </div>
           </div>
           <div class="layui-form-item">
               <div style="text-align: center">
                   <button class="layui-btn" lay-filter="add" lay-submit>修改</button>
                   <!--<button id="reset" type="reset" class="layui-btn layui-btn-primary">重置</button>-->
                </div>
            </div>
        </form>
    </div>

    <script>
        layui.use(['form', 'layer', 'jquery', 'layedit'],
                function () {
                    $ = layui.jquery;
                    var form = layui.form;
                    var layer = layui.layer;
                    var layedit = layui.layedit;


                    //初始化富文本编辑器
                    var index = layedit.build('content', {
                        height: 220//默认高度
                        //配置图片上传接口
                        , uploadImage: {
                            url: path+'/law/library/uploadImage.do' //接口url
                            , type: 'post' //默认post
                        }
                    });
                    form.render(); //更新全部

                    var id = GetRequest()['id']; //获取url中"?"符后的字串
                    //异步获取用户数据
                    $.ajax({
                        url: path+"/law/library/"+id+".do",
                        type:"get",
                        dataType:"json",
//                        async:false,
                        success:function (data) {
                            //回显数据
                            law_type_id=data.law_type_id;
                            if (data!=null){
                                // 设置表单初值
                                form.val("form", {
                                    title:data.title,
                                    content:data.content,
                                    id:data.id,
                                });
                                //更新表单
                                form.render();
                                layedit.setContent(index,data.content);
                            }else {
                                $("#form").html("没有该用户!或者服务器出现了一点小问题!");
                            }
                        },
                        error:function (data) {
                            $("#form").html("<div style='text-align:center'>服务器出现了一点小问题!</div>");
                        }
                    });


                    var law_type_id = GetRequest()['layid']; //获取url中"?"符后的字串
                    console.log(law_type_id);
                    //异步获取法务类型的数据
                    $.ajax({
                        url: path+'/law/type/list.do',
                        method: 'post',
                        data:{"status":1},
//                        async:false,
                        success: function (data) {
                            for (var i in data) {
                                var type = data[i];
                                if(type.id==law_type_id){
                                    $("#law_type_id").append("<option  selected='selected'  value=" + type.id + ">" + type.title + "</option>");
                                }else {
                                    $("#law_type_id").append("<option value=" + type.id + ">" + type.title + "</option>");
                                }
                                form.render("select");
                            }
                        }
                    });

                    //自定义验证规则
                    form.verify({
                        content: function (value) {
                            var text = layedit.getContent(index);
                            if (text == '') {
                                return "正文不能为空";
                            }
                            else
                                layedit.sync(index);
                        }
                    });
                    //监听重置按钮的点击事件
                    $("#reset").click(function () {
                        //清空富文本编辑器的内容
                        window.location.reload();
                    });

                    //监听提交
                    form.on('submit(add)',
                            function (data) {
                                var law_type_id = $("#law_type_id").val();
                        console.log(data.field);
                                $.ajax({
                                    url: path+"/law/library/update.do",
                                    type: "POST",
                                    data: {
                                        "id":id,
                                        "title": data.field.title,
                                        "law_type_id": law_type_id,
                                        "content": data.field.content,
                                    },
                                    dataType: "json",
                                    success: function (data) {
                                        if (data == 1) {
                                            layer.msg("修改成功", {icon: 1}, function () {

                                                //关闭当前frame
                                                xadmin.close();
                                                // 可以对父窗口进行刷新
                                                xadmin.father_reload();
                                            });
                                        }
                                    }
                                });
                                return false;
                            });
                });

        //获取url参数
        function GetRequest() {
            var url = decodeURI(location.search); //获取url中"?"符后的字串
            var theRequest = new Object();
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = 0; i < strs.length; i++) {
                    theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
                }
            }
            return theRequest;
        }

        //获取传递过来的数据，及绑定到当前页面元素中
        function mydata(data){
        }
    </script>
</div>
</body>
</html>